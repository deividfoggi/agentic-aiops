#Case:
# Temos um namespace com quota de 40milicore
# Para deployar a aplicação, requer 2 pods de 20milicore cada um, totalizando 40milicore
# Ao executar o Load Generator, o HPA vai aumentar a quantidade de pods para 4, totalizando 80milicore
# Porém, a quota do namespace é de 40milicore, o que vai gerar um erro de falta de recursos

#Runbook:
# Executar o login no Azure, definir os parâmetros e obeter as credenciais do AKS
# Executar os comandos de create/apply do Namespace, quota, deployment, service e hpa
# Executar o Load Generator, para gerar carga na aplicação (pegar o ip do service)
# Verificar os eventos do Kubernetes, para verificar o erro de falta de recursos

#Erro:
#Error creating: pods "hpa-deployment-5b5f4447c6-tj6mw" is forbidden: exceeded quota: limit-namespace-hpa-test, requested: limits.cpu=20m,requests.cpu=10m, used: limits.cpu=40m,requests.cpu=20m, limited: limits.cpu=40m,requests.cpu=20m


# Login no Azure
az login

# Parametros
rg=mas-aks-mvp
aks=MVP-AKS
ns=hpa-test

# Credenciais
az aks get-credentials -g $rg -n $aks

# Namespace 
kubectl get ns
kubectl create ns $ns
kubectl delete ns $ns

# Resource Quota
kubectl get resourcequota -n $ns
kubectl apply -f infra/case1-hpa-test/quota.yaml -n $ns
kubectl delete resourcequota limit-namespace-hpa-test -n $ns

# Deployments
kubectl get deploy -n $ns
kubectl apply -f infra/case1-hpa-test/deployment.yaml -n $ns
kubectl delete deployment hpa-deployment -n $ns

# Services
kubectl get svc -n $ns
kubectl apply -f infra/case1-hpa-test/service.yaml -n $ns
kubectl delete service hpa-deployment -n $ns

# Horizontal Pod AutoScaller
kubectl get hpa -n $ns
kubectl apply -f infra/case1-hpa-test/hpa.yaml -n $ns
kubectl delete hpa hpa-deployment -n $ns


# ...se estiver usando Bash no Windows
export MSYS_NO_PATHCONV=1

# Load Generator
kubectl run -i --tty load-generator --rm --image=busybox --restart=Never -- /bin/sh -c "while sleep 0.01; do wget -q -O- http://10.244.1.37:80; done" 
kubectl delete pod load-generator 

# Listar Eventos do Kubernetes
kubectl get events


# Clean up
kubectl delete hpa hpa-deployment -n $ns
kubectl delete service hpa-deployment -n $ns
kubectl delete deployment hpa-deployment -n $ns
kubectl delete resourcequota limit-namespace-hpa-test -n $ns
kubectl delete ns $ns
kubectl delete pod load-generator 